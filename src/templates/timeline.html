{% extends 'base.html' %}

{% block content %}
<div class="timeline-wrapper">

    <div style="flex-shrink: 0; margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h1 style="margin: 0;">Unified Timeline</h1>
        </div>

        <div style="margin-bottom: 1rem; background: white; padding: 0.75rem; border-radius: 6px; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; gap: 1rem; align-items: center;">
                <span style="font-size: 0.85rem; color: #666; text-transform: uppercase;">Saved Views:</span>
                <div id="savedViewsList" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
            </div>
            <button onclick="saveCurrentView()" style="background: none; border: 1px solid #d1d5db; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.85rem;">
                + Save Current
            </button>
        </div>

        <div class="filter-bar">
            <form id="filterForm" method="GET" action="{{ url_for('main.timeline_view') }}">
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                    <span style="font-size: 0.9rem; font-weight: bold; color: #666; margin-right: 0.5rem;">Show:</span>
                    
                    {% set filters = [
                        ('milestone', 'Milestones'),
                        ('financial', 'Financial'),
                        ('task', 'Tasks'),
                        ('asset', 'Purchases'),
                        ('maintenance', 'Maintenance'),
                        ('history', 'Appraisals')
                    ] %}

                    {% for code, label in filters %}
                    <label class="filter-chip {% if not current_filters or code in current_filters %}active{% endif %}">
                        <input type="checkbox" name="type" value="{{ code }}" 
                               {% if not current_filters or code in current_filters %}checked{% endif %}
                               onchange="document.getElementById('filterForm').submit()">
                        {{ label }}
                    </label>
                    {% endfor %}
                </div>
            </form>
        </div>
    </div>

    <div class="timeline-split-view">
        
        <div id="section-upcoming" class="timeline-column expanded reverse-layout">
            
            <div class="timeline-header header-green" onclick="toggleSection('upcoming')">
                <h2 style="margin: 0; display: flex; align-items: center; color: white;">
                    Upcoming & Active
                    <span class="toggle-icon" id="icon-upcoming" style="color: rgba(255,255,255,0.8); margin-left: 0.5rem;">▲</span>
                </h2>
                <span style="font-size: 0.85rem; color: rgba(255,255,255,0.9);">{{ upcoming|length }} Events</span>
            </div>
            
            <div class="timeline-scroll-area">
                {% if upcoming %}
                    {% for event in upcoming %}
                        <a href="{{ event.link }}" class="timeline-card type-{{ event.type }}">
                            <div class="timeline-icon">{{ event.icon }}</div>
                            <div class="timeline-content">
                                <div class="timeline-date">{{ event.date.strftime('%b %d, %Y') }}</div>
                                <div class="timeline-title">{{ event.title }}</div>
                                <div class="timeline-desc">{{ event.description }}</div>
                                <div class="timeline-badge badge-{{ event.type }}">{{ event.type_label }}</div>
                            </div>
                        </a>
                    {% endfor %}
                {% else %}
                    <p style="color: #999; font-style: italic; padding: 1rem; text-align: center;">No upcoming events matching filters.</p>
                {% endif %}
            </div>
        </div>

        <div id="section-history" class="timeline-column expanded">
            
            <div class="timeline-header header-gray" onclick="toggleSection('history')">
                <h2 style="margin: 0; display: flex; align-items: center; color: white;">
                    History & Logs
                    <span class="toggle-icon" id="icon-history" style="color: rgba(255,255,255,0.8); margin-left: 0.5rem;">▼</span>
                </h2>
                <span style="font-size: 0.85rem; color: rgba(255,255,255,0.9);">{{ history|length }} Events</span>
            </div>

            <div class="timeline-scroll-area">
                {% if history %}
                    {% for event in history %}
                        <a href="{{ event.link }}" class="timeline-card type-{{ event.type }} past">
                            <div class="timeline-icon">{{ event.icon }}</div>
                            <div class="timeline-content">
                                <div class="timeline-date">{{ event.date.strftime('%b %d, %Y') }}</div>
                                <div class="timeline-title">{{ event.title }}</div>
                                <div class="timeline-desc">{{ event.description }}</div>
                                <div class="timeline-badge badge-{{ event.type }}">{{ event.type_label }}</div>
                            </div>
                        </a>
                    {% endfor %}
                {% else %}
                    <p style="color: #999; font-style: italic; padding: 1rem; text-align: center;">No history found.</p>
                {% endif %}
            </div>
        </div>
    </div>

</div>

<script>
    // New function to handle split-view logic
    function updateLayoutState() {
        const upcoming = document.getElementById('section-upcoming');
        const history = document.getElementById('section-history');
        const wrapper = document.querySelector('.timeline-split-view');
        
        const isUpcomingOpen = upcoming.classList.contains('expanded');
        const isHistoryOpen = history.classList.contains('expanded');

        // Toggle dual-view class on wrapper
        if (isUpcomingOpen && isHistoryOpen) {
            wrapper.classList.add('dual-view');
        } else {
            wrapper.classList.remove('dual-view');
        }
    }

    function toggleSection(targetName) {
        const upcomingSec = document.getElementById('section-upcoming');
        const historySec = document.getElementById('section-history');
        const iconUpcoming = document.getElementById('icon-upcoming');
        const iconHistory = document.getElementById('icon-history');

        const target = targetName === 'upcoming' ? upcomingSec : historySec;
        const targetIcon = targetName === 'upcoming' ? iconUpcoming : iconHistory;

        // Determine specific icons
        const expandedIcon = targetName === 'upcoming' ? '▲' : '▼';
        const collapsedIcon = '◀';

        // Helper to update state and classes
        const setState = (el, icon, isCollapsed) => {
            if (isCollapsed) {
                el.classList.remove('expanded');
                el.classList.add('collapsed');
                icon.innerHTML = collapsedIcon; 
                
                // If collapsing Upcoming, remove reverse-layout
                if(el.id === 'section-upcoming') {
                    el.classList.remove('reverse-layout');
                }
            } else {
                el.classList.remove('collapsed');
                el.classList.add('expanded');
                icon.innerHTML = expandedIcon; 
                
                // If expanding Upcoming, add reverse-layout
                if(el.id === 'section-upcoming') {
                    el.classList.add('reverse-layout');
                }
            }
        };

        if (target.classList.contains('collapsed')) {
            // User is clicking a hidden section -> Expand it
            setState(target, targetIcon, false);
        } else {
            // User is clicking an open section -> Hide it
            setState(target, targetIcon, true);
        }
        
        // Update global layout class
        updateLayoutState();
    }
    
    // Initialize layout state on load
    document.addEventListener('DOMContentLoaded', updateLayoutState);

    // --- Saved Views Logic ---
    function saveCurrentView() {
        const name = prompt("Name this view:");
        if (!name) return;
        const currentSearch = window.location.search;
        const views = JSON.parse(localStorage.getItem('estate_timeline_views') || '{}');
        views[name] = currentSearch;
        localStorage.setItem('estate_timeline_views', JSON.stringify(views));
        renderSavedViews();
    }

    function deleteView(name) {
        if(!confirm('Delete "' + name + '"?')) return;
        const views = JSON.parse(localStorage.getItem('estate_timeline_views') || '{}');
        delete views[name];
        localStorage.setItem('estate_timeline_views', JSON.stringify(views));
        renderSavedViews();
    }

    function renderSavedViews() {
        const container = document.getElementById('savedViewsList');
        const views = JSON.parse(localStorage.getItem('estate_timeline_views') || '{}');
        let html = `<a href="{{ url_for('main.timeline_view') }}" class="saved-view-tag">View All</a>`;
        for (const [name, search] of Object.entries(views)) {
            html += `
                <span class="saved-view-group">
                    <a href="{{ url_for('main.timeline_view') }}${search}" class="saved-view-tag custom">${name}</a>
                    <button onclick="deleteView('${name}')" class="saved-view-del">&times;</button>
                </span>
            `;
        }
        container.innerHTML = html;
    }
    document.addEventListener('DOMContentLoaded', renderSavedViews);
</script>
{% endblock %}