{% extends 'base.html' %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto;">
    
    <div style="margin-bottom: 1.5rem;">
        <a href="{{ url_for('main.assets_view') }}" style="display: inline-flex; align-items: center; color: #6b7280; text-decoration: none; font-weight: 500; font-size: 0.9rem;">
            <span style="margin-right: 0.5rem;">&larr;</span> Back to Assets
        </a>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
        <div>
            <div style="font-size: 0.9rem; color: #666; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">
                {{ asset.asset_type }}
            </div>
            <h1 style="margin: 0; font-size: 2.5rem;">{{ asset.name }}</h1>
            {% if asset.owner %}
                <div style="margin-top: 0.5rem; color: #666;">Owned by {{ asset.owner.name }}</div>
            {% elif asset.is_in_trust %}
                <div style="margin-top: 0.5rem; color: #065f46; background: #d1fae5; display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.9rem;">
                    Held in Trust
                </div>
            {% endif %}
        </div>
        <div style="text-align: right;">
            <div style="font-size: 2.5rem; font-weight: bold; color: {% if asset.value_estimated < 0 %}#ef4444{% else %}#10b981{% endif %};">
                ${{ "{:,.0f}".format(asset.value_estimated) }}
            </div>
            <div style="color: #666; font-size: 0.9rem;">Current Estimated Value</div>
            <a href="{{ url_for('manage.manage_asset', id=asset.id) }}" style="display: inline-block; margin-top: 1rem; color: #2563eb; text-decoration: none;">
                ✎ Edit Details
            </a>
        </div>
    </div>

    <div class="grid-2-sidebar" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
        
        <div>
            <div class="summary-card" style="margin-bottom: 2rem;">
                <h3 style="margin-top: 0;">Value History</h3>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="valueChart"></canvas>
                </div>
            </div>

            <div class="summary-card">
                <h3 style="margin-top: 0; margin-bottom: 1rem;">Appraisal Log</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Value</th>
                            <th>Source</th>
                            <th>Notes</th>
                            <th style="width: 50px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in asset.appraisals %}
                        <tr>
                            <td>{{ record.date.strftime('%Y-%m-%d') }}</td>
                            <td style="font-weight: bold;">${{ "{:,.0f}".format(record.value) }}</td>
                            <td>{{ record.source }}</td>
                            <td style="color: #666; font-size: 0.9rem;">{{ record.notes or '' }}</td>
                            <td style="text-align: right;">
                                <button type="button" 
                                    onclick="openEditModal('{{ record.id }}', '{{ record.date }}', '{{ record.value }}', '{{ record.source }}', '{{ record.notes or '' }}')"
                                    style="background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 0.25rem;" 
                                    title="Edit Valuation">
                                    ✎
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" style="text-align: center; color: #999;">No historical records yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div>
            <div class="summary-card" style="background: #f0f9ff; border-color: #bae6fd; margin-bottom: 2rem;">
                <h3 style="margin-top: 0; color: #0369a1;">Update Value</h3>
                <form method="POST" action="{{ url_for('manage.add_appraisal', id=asset.id) }}">
                    {{ form.hidden_tag() }}
                    
                    <div style="margin-bottom: 1rem;">
                        {{ form.date.label(style="display:block; font-size:0.85rem; font-weight:bold; margin-bottom:0.3rem;") }}
                        {{ form.date(style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px;") }}
                    </div>

                    <div style="margin-bottom: 1rem;">
                        {{ form.value.label(style="display:block; font-size:0.85rem; font-weight:bold; margin-bottom:0.3rem;") }}
                        {{ form.value(style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px;", placeholder="0.00") }}
                    </div>

                    <div style="margin-bottom: 1rem;">
                        {{ form.source.label(style="display:block; font-size:0.85rem; font-weight:bold; margin-bottom:0.3rem;") }}
                        {{ form.source(style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px;", placeholder="e.g. Zillow") }}
                    </div>

                    <div style="margin-bottom: 1rem;">
                        {{ form.notes.label(style="display:block; font-size:0.85rem; font-weight:bold; margin-bottom:0.3rem;") }}
                        {{ form.notes(style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px; font-family: inherit;", rows=2, placeholder="Optional details...") }}
                    </div>

                    <button type="submit" style="width: 100%; background: #0284c7; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        Record Valuation
                    </button>
                </form>
            </div>

            <div class="summary-card">
                <h3 style="margin-top: 0;">Details</h3>
                {% if asset.attributes %}
                    {% for key, value in asset.attributes.items() %}
                    <div style="margin-bottom: 0.75rem; border-bottom: 1px solid #f3f4f6; padding-bottom: 0.5rem;">
                        <div style="font-size: 0.8rem; color: #999; text-transform: uppercase;">{{ key|replace('_', ' ') }}</div>
                        <div style="font-size: 1rem;">{{ value }}</div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: #999;">No specific details recorded.</p>
                {% endif %}
            </div>
        </div>

    </div>
</div>

<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center;">
    <div style="background: white; width: 100%; max-width: 500px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); padding: 2rem;">
        <h2 style="margin-top: 0; margin-bottom: 1.5rem;">Edit Appraisal</h2>
        
        <form id="editForm" method="POST">
            {{ form.hidden_tag() }}
            
            <div style="margin-bottom: 1rem;">
                <label style="display:block; font-weight:bold; margin-bottom:0.3rem;">Date</label>
                <input type="date" name="date" id="modalDate" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display:block; font-weight:bold; margin-bottom:0.3rem;">Value ($)</label>
                <input type="number" step="any" name="value" id="modalValue" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display:block; font-weight:bold; margin-bottom:0.3rem;">Source</label>
                <input type="text" name="source" id="modalSource" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display:block; font-weight:bold; margin-bottom:0.3rem;">Notes</label>
                <textarea name="notes" id="modalNotes" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-family: inherit;"></textarea>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <button type="submit" id="btnDelete" formnovalidate class="danger-btn">Delete</button>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button type="button" onclick="closeEditModal()" style="background: white; border: 1px solid #ccc; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Cancel</button>
                    <button type="submit" id="btnSave" style="background: #2563eb; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Save Changes</button>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
    .danger-btn { background: #fee2e2; color: #b91c1c; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; transition: background 0.2s; }
    .danger-btn:hover { background: #fecaca; }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
    // --- Chart Logic ---
    const ctx = document.getElementById('valueChart');
    const dates = {{ chart_dates | tojson }};
    const values = {{ chart_values | tojson }};

    if(ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates, // Strings in ISO format work with the adapter
                datasets: [{
                    label: 'Asset Value ($)',
                    data: values,
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: { color: '#f3f4f6' }
                    },
                    x: {
                        type: 'time', // Uses the date-fns adapter
                        time: {
                            tooltipFormat: 'MMM d, yyyy',
                            displayFormats: {
                                year: 'yyyy',
                                month: 'MMM yyyy'
                            }
                        },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // --- Modal Logic ---
    const modal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    const btnSave = document.getElementById('btnSave');
    const btnDelete = document.getElementById('btnDelete');

    function openEditModal(id, date, value, source, notes) {
        // Populate fields
        document.getElementById('modalDate').value = date; // Expects YYYY-MM-DD
        document.getElementById('modalValue').value = value;
        document.getElementById('modalSource').value = source;
        document.getElementById('modalNotes').value = notes;

        // Set Actions
        const baseEditUrl = "{{ url_for('manage.edit_appraisal', id=0) }}".replace('0', id);
        const baseDeleteUrl = "{{ url_for('manage.delete_appraisal', id=0) }}".replace('0', id);

        // Default submit is Edit
        editForm.action = baseEditUrl;
        
        // Delete button uses formaction to override
        btnDelete.setAttribute('formaction', baseDeleteUrl);
        btnDelete.onclick = function() {
            return confirm('Are you sure you want to permanently delete this valuation record?');
        };

        // Show Modal
        modal.style.display = 'flex';
    }

    function closeEditModal() {
        modal.style.display = 'none';
    }

    // Close on background click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeEditModal();
        }
    });
</script>
{% endblock %}