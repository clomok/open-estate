{% extends 'base.html' %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto;">
    
    <div style="margin-bottom: 1.5rem;">
        <a href="{{ url_for('main.assets_view') }}" style="display: inline-flex; align-items: center; color: #6b7280; text-decoration: none; font-weight: 500; font-size: 0.9rem;">
            <span style="margin-right: 0.5rem;">&larr;</span> Back to Assets
        </a>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
        <div>
            <div style="font-size: 0.9rem; color: #666; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">
                {{ asset.asset_type }}
            </div>
            <h1 style="margin: 0; font-size: 2.5rem;">{{ asset.name }}</h1>
            {% if asset.owner %}
                <div style="margin-top: 0.5rem; color: #666;">Owned by {{ asset.owner.name }}</div>
            {% elif asset.is_in_trust %}
                <div style="margin-top: 0.5rem; color: #065f46; background: #d1fae5; display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.9rem;">
                    Held in Trust
                </div>
            {% endif %}
        </div>
        <div style="text-align: right;">
            <div style="font-size: 2.5rem; font-weight: bold; color: {% if asset.value_estimated < 0 %}#ef4444{% else %}#10b981{% endif %};">
                ${{ "{:,.0f}".format(asset.value_estimated) }}
            </div>
            <div style="color: #666; font-size: 0.9rem;">Current Estimated Value</div>
            <a href="{{ url_for('manage.manage_asset', id=asset.id) }}" style="display: inline-block; margin-top: 1rem; color: #2563eb; text-decoration: none;">
                ‚úé Edit Asset
            </a>
        </div>
    </div>

    <div class="tabs-header" style="display: flex; border-bottom: 2px solid #e5e7eb; margin-bottom: 2rem; overflow-x: auto;">
        <button class="tab-btn active" onclick="openTab(event, 'tab-overview')">Overview</button>
        {% if asset.asset_type == 'RealEstate' %}
            <button class="tab-btn" onclick="openTab(event, 'tab-structures')">Accommodations</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-systems')">Systems & Pins</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-bills')">Financials</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-team')">Team</button>
        {% endif %}
    </div>

    <div id="tab-overview" class="tab-content">
        <div class="grid-2-sidebar" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
            <div>
                <div class="summary-card" style="margin-bottom: 2rem;">
                    <h3 style="margin-top: 0;">Value History</h3>
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="valueChart"></canvas>
                    </div>
                </div>

                <div class="summary-card">
                    <h3 style="margin-top: 0; margin-bottom: 1rem;">Appraisal Log</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Value</th>
                                <th>Source</th>
                                <th>Notes</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in asset.appraisals %}
                            <tr>
                                <td>{{ record.date.strftime('%Y-%m-%d') }}</td>
                                <td style="font-weight: bold;">${{ "{:,.0f}".format(record.value) }}</td>
                                <td>{{ record.source }}</td>
                                <td style="color: #666; font-size: 0.9rem;">{{ record.notes or '' }}</td>
                                <td style="text-align: right;">
                                    <button type="button" 
                                        onclick="openEditModal('{{ record.id }}', '{{ record.date }}', '{{ record.value }}', '{{ record.source }}', '{{ record.notes or '' }}')"
                                        style="background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 0.25rem;">
                                        ‚úé
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" style="text-align: center; color: #999;">No historical records yet.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div>
                <div class="summary-card" style="background: #f0f9ff; border-color: #bae6fd; margin-bottom: 2rem;">
                    <h3 style="margin-top: 0; color: #0369a1;">Update Value</h3>
                    <form method="POST" action="{{ url_for('manage.add_appraisal', id=asset.id) }}">
                        {{ form.hidden_tag() }}
                        <div style="margin-bottom: 1rem;">
                            {{ form.date(style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px;") }}
                        </div>
                        <div style="margin-bottom: 1rem;">
                            {{ form.value(style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px;", placeholder="Value $") }}
                        </div>
                        <div style="margin-bottom: 1rem;">
                            {{ form.source(style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px;", placeholder="Source") }}
                        </div>
                        <div style="margin-bottom: 1rem;">
                            {{ form.notes(style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px;", placeholder="Notes...", rows=2) }}
                        </div>
                        <button type="submit" style="width: 100%; background: #0284c7; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">
                            Record Valuation
                        </button>
                    </form>
                </div>

                <div class="summary-card">
                    <h3 style="margin-top: 0;">Details</h3>
                    {% if asset.attributes %}
                        {% for key, value in asset.attributes.items() %}
                        <div style="margin-bottom: 0.75rem; border-bottom: 1px solid #f3f4f6; padding-bottom: 0.5rem;">
                            <div style="font-size: 0.8rem; color: #999; text-transform: uppercase;">{{ key|replace('_', ' ') }}</div>
                            <div style="font-size: 1rem;">{{ value }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p style="color: #999;">No details.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div id="tab-structures" class="tab-content" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h3>Sheds, Decks & Pools</h3>
            <a href="{{ url_for('manage.manage_subitem', id=asset.id, subitem_type='structure') }}" class="btn-primary">+ Add Structure</a>
        </div>
        <div class="grid-3">
            {% for item in asset.structures %}
            <div class="summary-card">
                <div style="font-weight:bold; font-size:1.1rem;">{{ item.name }}</div>
                <div style="font-size:0.85rem; color:#666; margin-bottom:0.5rem;">{{ item.structure_type }}</div>
                <p>{{ item.description }}</p>
                {% if item.date_last_maintained %}
                <div style="font-size:0.85rem; color:#059669; margin-top:0.5rem;">
                    Last Maint: {{ item.date_last_maintained }}
                </div>
                {% endif %}
                <div style="margin-top:1rem; border-top:1px solid #eee; padding-top:0.5rem; text-align:right;">
                    <a href="{{ url_for('manage.delete_subitem', asset_id=asset.id, subitem_type='structure', item_id=item.id) }}" style="color:#ef4444; font-size:0.85rem;" onclick="return confirm('Delete?')">Remove</a>
                </div>
            </div>
            {% else %}
            <p style="color:#999;">No structures recorded.</p>
            {% endfor %}
        </div>
    </div>

    <div id="tab-systems" class="tab-content" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h3>Coordinate Ledger</h3>
            <a href="{{ url_for('manage.manage_subitem', id=asset.id, subitem_type='location') }}" class="btn-primary">üìç Drop Pin</a>
        </div>
        
        <table class="data-table">
            <thead>
                <tr>
                    <th>Label</th>
                    <th>Coordinates</th>
                    <th>Description</th>
                    <th>Map</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for pin in asset.location_points %}
                <tr>
                    <td style="font-weight:bold;">{{ pin.label }}</td>
                    <td style="font-family:monospace;">{{ "%.6f"|format(pin.latitude) }}, {{ "%.6f"|format(pin.longitude) }}</td>
                    <td>{{ pin.description }}</td>
                    <td>
                        <a href="https://www.google.com/maps/search/?api=1&query={{ pin.latitude }},{{ pin.longitude }}" target="_blank" style="color:#2563eb;">Open Map</a>
                    </td>
                    <td style="text-align:right;">
                        <a href="{{ url_for('manage.delete_subitem', asset_id=asset.id, subitem_type='location', item_id=pin.id) }}" style="color:#ef4444;" onclick="return confirm('Delete pin?')">&times;</a>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="5" style="text-align:center; color:#999;">No pins dropped yet. Use "Drop Pin" while standing at the location.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="tab-bills" class="tab-content" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h3>Recurring Bills</h3>
            <a href="{{ url_for('manage.manage_subitem', id=asset.id, subitem_type='bill') }}" class="btn-primary">+ Add Bill</a>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Bill Name</th>
                    <th>Payee</th>
                    <th>Frequency</th>
                    <th>Amount (Est)</th>
                    <th>Next Due</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for bill in asset.bills %}
                <tr>
                    <td style="font-weight:bold;">{{ bill.name }}</td>
                    <td>{{ bill.payee }}</td>
                    <td>{{ bill.frequency }}</td>
                    <td>${{ bill.amount_estimated }}</td>
                    <td>{{ bill.next_due_date or '-' }}</td>
                    <td style="text-align:right;">
                        <a href="{{ url_for('manage.delete_subitem', asset_id=asset.id, subitem_type='bill', item_id=bill.id) }}" style="color:#ef4444;" onclick="return confirm('Remove bill?')">&times;</a>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="6" style="text-align:center; color:#999;">No recurring bills linked.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="tab-team" class="tab-content" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h3>Vendors & Service Providers</h3>
            <a href="{{ url_for('manage.manage_subitem', id=asset.id, subitem_type='vendor') }}" class="btn-primary">+ Assign Vendor</a>
        </div>
        <div class="grid-3">
            {% for link in asset.vendors %}
            <div class="summary-card" style="border-left: 4px solid #059669;">
                <div style="font-weight:bold; font-size:1.1rem;">{{ link.provider.name }}</div>
                <div style="background:#d1fae5; color:#065f46; display:inline-block; padding:2px 8px; border-radius:4px; font-size:0.8rem; margin: 0.5rem 0;">{{ link.role }}</div>
                <div style="font-size:0.9rem;">
                    <div>{{ link.provider.phone or '' }}</div>
                    <div>{{ link.provider.email or '' }}</div>
                </div>
                <div style="margin-top:0.5rem; font-style:italic; font-size:0.85rem; color:#666;">
                    {{ link.notes }}
                </div>
                <div style="text-align:right; margin-top:1rem;">
                    <a href="{{ url_for('manage.delete_subitem', asset_id=asset.id, subitem_type='vendor', item_id=link.id) }}" style="color:#ef4444; font-size:0.85rem;" onclick="return confirm('Unassign?')">Unassign</a>
                </div>
            </div>
            {% else %}
            <p style="color:#999;">No specific vendors assigned to this property.</p>
            {% endfor %}
        </div>
    </div>

</div>

<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center;">
    <div style="background: white; width: 100%; max-width: 500px; border-radius: 8px; padding: 2rem;">
        <h2 style="margin-top: 0;">Edit Appraisal</h2>
        <form id="editForm" method="POST">
            {{ form.hidden_tag() }}
            <div style="margin-bottom: 1rem;">
                <label>Date</label><input type="date" name="date" id="modalDate" required style="width: 100%; padding: 0.5rem; border:1px solid #ccc;">
            </div>
            <div style="margin-bottom: 1rem;">
                <label>Value</label><input type="number" step="any" name="value" id="modalValue" required style="width: 100%; padding: 0.5rem; border:1px solid #ccc;">
            </div>
            <div style="margin-bottom: 1rem;">
                <label>Source</label><input type="text" name="source" id="modalSource" style="width: 100%; padding: 0.5rem; border:1px solid #ccc;">
            </div>
            <div style="margin-bottom: 1rem;">
                <label>Notes</label><textarea name="notes" id="modalNotes" style="width: 100%; padding: 0.5rem; border:1px solid #ccc;"></textarea>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <button type="submit" id="btnDelete" formnovalidate style="background:#fee2e2; color:#b91c1c; border:none; padding:0.5rem 1rem;">Delete</button>
                <div>
                    <button type="button" onclick="closeEditModal()" style="margin-right:0.5rem;">Cancel</button>
                    <button type="submit" id="btnSave" style="background:#2563eb; color:white; border:none; padding:0.5rem 1rem;">Save</button>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
    .tabs-header { margin-bottom: 2rem; }
    .tab-btn {
        background: none; border: none; padding: 0.75rem 1.5rem; font-size: 1rem; cursor: pointer;
        color: #6b7280; border-bottom: 2px solid transparent; white-space: nowrap;
    }
    .tab-btn:hover { color: #1f2937; }
    .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; font-weight: bold; }
    .btn-primary { background: #2563eb; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem; }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
    // Tab Logic
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        if(evt) evt.currentTarget.className += " active";
    }

    // Modal Logic (Existing)
    const modal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    const btnDelete = document.getElementById('btnDelete');

    function openEditModal(id, date, value, source, notes) {
        document.getElementById('modalDate').value = date;
        document.getElementById('modalValue').value = value;
        document.getElementById('modalSource').value = source;
        document.getElementById('modalNotes').value = notes;
        editForm.action = "{{ url_for('manage.edit_appraisal', id=0) }}".replace('0', id);
        btnDelete.setAttribute('formaction', "{{ url_for('manage.delete_appraisal', id=0) }}".replace('0', id));
        btnDelete.onclick = function() { return confirm('Delete record?'); };
        modal.style.display = 'flex';
    }
    function closeEditModal() { modal.style.display = 'none'; }
    modal.addEventListener('click', function(e) { if (e.target === modal) closeEditModal(); });

    // Chart Logic (Existing)
    const ctx = document.getElementById('valueChart');
    if(ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ chart_dates | tojson }},
                datasets: [{
                    label: 'Value', data: {{ chart_values | tojson }},
                    borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { x: { type: 'time', time: { unit: 'year' } } }
            }
        });
    }
</script>
{% endblock %}