{% extends 'base.html' %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto;">
    
    <div style="margin-bottom: 1.5rem;">
        <a href="{{ url_for('main.assets_view') }}" style="display: inline-flex; align-items: center; color: #6b7280; text-decoration: none; font-weight: 500; font-size: 0.9rem;">
            <span style="margin-right: 0.5rem;">&larr;</span> Back to Assets
        </a>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
        <div>
            <div style="font-size: 0.9rem; color: #666; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">
                {{ asset.asset_type }}
            </div>
            <h1 style="margin: 0; font-size: 2.5rem;">{{ asset.name }}</h1>
            {% if asset.owner %}
                <div style="margin-top: 0.5rem; color: #666;">Owned by {{ asset.owner.name }}</div>
            {% elif asset.is_in_trust %}
                <div style="margin-top: 0.5rem; color: #065f46; background: #d1fae5; display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.9rem;">
                    Held in Trust
                </div>
            {% endif %}
        </div>
        <div style="text-align: right;">
            <div style="font-size: 2.5rem; font-weight: bold; color: {% if asset.value_estimated < 0 %}#ef4444{% else %}#10b981{% endif %};">
                ${{ "{:,.0f}".format(asset.value_estimated) }}
            </div>
            <div style="color: #666; font-size: 0.9rem;">Current Estimated Value</div>
            <a href="{{ url_for('manage.manage_asset', id=asset.id) }}" style="display: inline-block; margin-top: 1rem; color: #2563eb; text-decoration: none;">
                âœŽ Edit Details
            </a>
        </div>
    </div>

    <div class="grid-2-sidebar" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
        
        <div>
            <div class="summary-card" style="margin-bottom: 2rem;">
                <h3 style="margin-top: 0;">Value History</h3>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="valueChart"></canvas>
                </div>
            </div>

            <div class="summary-card">
                <h3 style="margin-top: 0; margin-bottom: 1rem;">Appraisal Log</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Value</th>
                            <th>Source</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in asset.appraisals %}
                        <tr>
                            <td>{{ record.date.strftime('%Y-%m-%d') }}</td>
                            <td style="font-weight: bold;">${{ "{:,.0f}".format(record.value) }}</td>
                            <td>{{ record.source }}</td>
                            <td style="color: #666; font-size: 0.9rem;">{{ record.notes or '' }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align: center; color: #999;">No historical records yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div>
            <div class="summary-card" style="background: #f0f9ff; border-color: #bae6fd; margin-bottom: 2rem;">
                <h3 style="margin-top: 0; color: #0369a1;">Update Value</h3>
                <form method="POST" action="{{ url_for('manage.add_appraisal', id=asset.id) }}">
                    {{ form.hidden_tag() }}
                    
                    <div style="margin-bottom: 1rem;">
                        {{ form.date.label(style="display:block; font-size:0.85rem; font-weight:bold; margin-bottom:0.3rem;") }}
                        {{ form.date(style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px;") }}
                    </div>

                    <div style="margin-bottom: 1rem;">
                        {{ form.value.label(style="display:block; font-size:0.85rem; font-weight:bold; margin-bottom:0.3rem;") }}
                        {{ form.value(style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px;", placeholder="0.00") }}
                    </div>

                    <div style="margin-bottom: 1rem;">
                        {{ form.source.label(style="display:block; font-size:0.85rem; font-weight:bold; margin-bottom:0.3rem;") }}
                        {{ form.source(style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px;", placeholder="e.g. Zillow") }}
                    </div>

                    <button type="submit" style="width: 100%; background: #0284c7; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        Record Valuation
                    </button>
                </form>
            </div>

            <div class="summary-card">
                <h3 style="margin-top: 0;">Details</h3>
                {% if asset.attributes %}
                    {% for key, value in asset.attributes.items() %}
                    <div style="margin-bottom: 0.75rem; border-bottom: 1px solid #f3f4f6; padding-bottom: 0.5rem;">
                        <div style="font-size: 0.8rem; color: #999; text-transform: uppercase;">{{ key|replace('_', ' ') }}</div>
                        <div style="font-size: 1rem;">{{ value }}</div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: #999;">No specific details recorded.</p>
                {% endif %}
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('valueChart');
    const dates = {{ chart_dates | tojson }};
    const values = {{ chart_values | tojson }};

    if(ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Asset Value ($)',
                    data: values,
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: { color: '#f3f4f6' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }
</script>
{% endblock %}