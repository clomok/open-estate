<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Estate Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    
    <button id="sidebarToggle" class="mobile-toggle" aria-label="Open Menu">
        &#10140; 
    </button>

    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <aside id="sidebar" class="sidebar">
        <div class="sidebar-title">The Trust</div>
        
        <nav>
            <a href="{{ url_for('main.dashboard') }}" class="nav-item {% if active_page == 'overview' %}active{% endif %}">
                Overview
            </a>
            <a href="{{ url_for('main.assets_view') }}" class="nav-item {% if active_page == 'assets' %}active{% endif %}">
                Assets & Liabilities
            </a>
            <a href="{{ url_for('main.planning_view') }}" class="nav-item {% if active_page == 'planning' %}active{% endif %}">
                Planning
            </a>
            <a href="{{ url_for('main.details_view') }}" class="nav-item {% if active_page == 'details' %}active{% endif %}">
                Contacts
            </a>
            <a href="{{ url_for('main.faq_view') }}" class="nav-item {% if active_page == 'faq' %}active{% endif %}">
                FAQ
            </a>
        </nav>

        <div style="margin-top: auto; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1);">
            <a href="{{ url_for('settings.index') }}" class="nav-item {% if active_page == 'settings' %}active{% endif %}">Settings</a>
            <a href="{{ url_for('auth.logout') }}" class="nav-item" style="color: #fca5a5;">Logout</a>
        </div>
    </aside>

    <main class="main-content">
        <div class="toast-container">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                    <div class="toast {{ category }}">
                        <div class="toast-message">{{ message }}</div>
                        <button class="toast-close" aria-label="Close">
                            <svg class="timer-svg" viewBox="0 0 32 32">
                                <circle class="timer-circle-bg" cx="16" cy="16" r="14"></circle>
                                <circle class="timer-progress" cx="16" cy="16" r="14"></circle>
                            </svg>
                            <span style="position: relative; z-index: 2; font-size: 1.2rem; line-height: 1;">&times;</span>
                        </button>
                    </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        {% block content %}{% endblock %}
    </main>

    <script>
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const toggleBtn = document.getElementById('sidebarToggle');
        
        // Function to toggle state
        function toggleMenu() {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            
            // Rotate arrow based on state
            if(sidebar.classList.contains('open')) {
                toggleBtn.innerHTML = '&#10005;'; // X symbol
            } else {
                toggleBtn.innerHTML = '&#10140;'; // Right Arrow
            }
        }

        // 1. Click Toggle
        toggleBtn.addEventListener('click', toggleMenu);

        // 2. Click Overlay to Close
        overlay.addEventListener('click', toggleMenu);

        // 3. Auto-hide when loading a new page (Standard link clicks)
        document.querySelectorAll('.nav-item').forEach(link => {
            link.addEventListener('click', () => {
                if(window.innerWidth <= 768) {
                    sidebar.classList.remove('open');
                    overlay.classList.remove('active');
                }
            });
        });

        // 4. Touch Gestures (Swipe)
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, {passive: true});

        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, {passive: true});

        function handleSwipe() {
            const threshold = 50; 
            const edgeLimit = 50; 

            if (touchEndX - touchStartX > threshold) {
                if (touchStartX < edgeLimit && !sidebar.classList.contains('open')) {
                    toggleMenu();
                }
            }
            
            if (touchStartX - touchEndX > threshold) {
                if (sidebar.classList.contains('open')) {
                    toggleMenu();
                }
            }
        }

        // 5. Toast Notification Logic
        document.addEventListener('DOMContentLoaded', () => {
            const toasts = document.querySelectorAll('.toast');
            
            toasts.forEach(toast => {
                const closeBtn = toast.querySelector('.toast-close');
                
                const dismiss = () => {
                    // Start fade out animation
                    toast.style.animation = 'fadeOut 0.3s forwards';
                    // Remove from DOM after animation completes
                    toast.addEventListener('animationend', () => {
                        toast.remove();
                    });
                };

                // Manual Close
                closeBtn.addEventListener('click', dismiss);

                // Auto Close Timer (5 seconds)
                setTimeout(dismiss, 5000);
            });
        });
    </script>
</body>
</html>